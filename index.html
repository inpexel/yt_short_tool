<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0"
  />
  <title>YouTube Quiz Creator</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Arial', sans-serif;
      background: linear-gradient(
        -45deg,
        #ff9a9e 0%, /* More vibrant and smoother gradient */
        #fecfef 25%,
        #a1c4fd 50%,
        #c2e9fb 75%,
        #ff9a9e 100%
      );
      background-size: 500% 500%; /* Adjusted for more colors */
      animation: gradientBG 20s ease-in-out infinite; /* Smoother animation */
      min-height: 100vh;
      overflow-x: hidden;
      overflow-y: auto;
    }

    @keyframes gradientBG {
      0% {
        background-position: 0% 50%;
      }
      50% {
        background-position: 100% 50%;
      }
      100% {
        background-position: 0% 50%;
      }
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    .home-screen {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      width: 100%;
      max-width: 600px;
    }

    .logo {
      text-align: center;
      margin-bottom: 30px;
    }

    .logo h1 {
      color: #333;
      font-size: 2.5rem;
      margin-bottom: 10px;
      background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .logo p {
      color: #666;
      font-size: 1.1rem;
    }

    .tabs {
      display: flex;
      margin-bottom: 20px;
      border-radius: 10px;
      overflow: hidden;
      background: #f0f0f0;
    }

    .tab {
      flex: 1;
      padding: 15px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: bold;
    }

    .tab.active {
      background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
      color: white;
    }

    .tab:not(.active):hover {
      background: #e0e0e0;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .json-input {
      width: 100%;
      height: 200px;
      padding: 15px;
      border: 2px solid #ddd;
      border-radius: 10px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      resize: vertical;
      transition: border-color 0.3s ease;
    }

    .json-input:focus {
      outline: none;
      border-color: #4ecdc4;
    }

    .manual-input {
      margin-bottom: 20px;
    }

    .question-form {
      background: #f9f9f9;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 15px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #333;
    }

    .form-group input[type='text'],
    .form-group input[type='number'],
    .form-group select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
    }
    .form-group input[type='checkbox'] {
      width: auto;
      margin-right: 8px;
      vertical-align: middle;
    }

    .options-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 15px;
    }

    .correct-answer-select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }

    .subscribe {
      background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 5px;
    }

    .btn-sbs {
      background: linear-gradient(45deg, #ff1515, #f70000);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 5px;
    }

    .btn {
      background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 5px;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
    }

    .btn-secondary {
      background: #6c757d;
    }

    .generate-btn {
      width: 100%;
      margin-top: 20px;
      padding: 20px;
      font-size: 18px;
    }

    /* Quiz Screen Styles */
    .quiz-screen {
      display: none;
      position: fixed;
      /* New energetic gradient for quiz screen */
      background: linear-gradient(
        -45deg,
        #ff3e9d 0%, /* Bright pink */
        #ffb86c 25%, /* Bright orange */
        #ffee70 50%, /* Bright yellow */
        #86f7c2 75%, /* Bright mint */
        #62cff4 100% /* Bright cyan */
      );
      background-size: 500% 500%; /* Adjusted for more colors */
      animation: gradientBG 18s ease-in-out infinite; /* Smoother and slightly faster */
      z-index: 1000;
      transition: background 0.5s ease;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      transform-origin: center center;
    }

    .quiz-screen.ended {
      background: white;
      animation: none;
    }

    .quiz-container {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      width: 100%;
      height: 100%;
      padding: 20px; /* Base padding, can be overridden by modes */
      position: relative;
    }

    .quiz-header {
      position: absolute;
      top: 40px; /* Increased top for more space */
      left: 50%;
      transform: translateX(-50%);
      color: white;
      font-size: 2rem; /* Increased base size */
      font-weight: bold;
      z-index: 1001;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    .quiz-screen.ended .quiz-header {
      color: #333;
    }

    .question-card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 20px; /* Base padding */
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(15px);
      border: 2px solid rgba(255, 255, 255, 0.3);
      max-width: 95%;
      width: 90%;
      text-align: center;
      transform: translateX(0);
      transition: transform 0.5s ease, opacity 0.5s ease;
      overflow: hidden; /* IMPORTANT: Prevent internal scrolling */
      display: flex;
      flex-direction: column;
      justify-content: space-around; /* Distribute space if possible */
      /* max-height will be set by modes or responsive styles */
    }

    .question-card.slide-out {
      transform: translateX(-100vw);
      opacity: 0;
    }

    .question-card.slide-in {
      transform: translateX(100vw);
      opacity: 0;
      animation: slideIn 0.5s ease forwards;
    }

    @keyframes slideIn {
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .question-text {
      font-size: 1.8rem; /* Base size */
      color: #333;
      margin-bottom: 25px; /* Adjusted margin */
      font-weight: bold;
      line-height: 1.3; /* Improved line height */
    }

    .timer-circle {
      width: 90px; /* Increased size */
      height: 90px; /* Increased size */
      border-radius: 50%;
      background: conic-gradient(
        #4ecdc4 360deg,
        #f0f0f0 360deg
      );
      display: flex;
      justify-content: center;
      align-items: center;
      position: absolute;
      top: 30px; /* Adjusted position */
      right: 30px; /* Adjusted position */
      z-index: 1005;
      margin: 0;
      transition: background 0.2s linear;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }

    .timer-circle::before {
      content: '';
      position: absolute;
      width: 70px; /* Increased size */
      height: 70px; /* Increased size */
      background: white;
      border-radius: 50%;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1) inset;
    }

    .timer-number {
      font-size: 2.5rem; /* Increased size */
      font-weight: bold;
      color: #333;
      position: relative;
      z-index: 1;
    }

    .options-grid {
      display: grid; /* Default, will be overridden by modes */
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-top: 20px; /* Adjusted margin */
      width: 100%;
    }

    .option {
      background: #f8f9fa;
      border: 2px solid #e9ecef;
      border-radius: 15px;
      padding: 15px; /* Base padding */
      font-size: 1.1rem; /* Base font size */
      font-weight: 500;
      color: #333;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      text-align: left;
      display: flex;
      align-items: center;
      word-break: break-word; /* Ensure long words wrap */
    }

    .option:hover {
      background: #e9ecef;
      transform: translateY(-2px);
    }

    .option-label {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px; /* Increased size */
      height: 40px; /* Increased size */
      background-color: #e0f7f4;
      color: #007f75;
      font-weight: 700;
      font-size: 1.2rem; /* Increased font size */
      border-radius: 50%;
      border: 2px solid #4ecdc4;
      margin-right: 15px; /* Increased margin */
      flex-shrink: 0;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }


    .option.correct {
      background: #d4edda;
      color: #155724;
      border: 3px solid #28a745 !important;
      transform: scale(1.02); /* Slight emphasis */
    }

    .option.correct::after {
      content: '✓';
      position: absolute;
      top: -12px; /* Adjusted */
      right: -12px; /* Adjusted */
      background: #28a745;
      color: white;
      width: 34px; /* Increased */
      height: 34px; /* Increased */
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: bold;
      font-size: 1.4rem; /* Increased */
    }

    .subscribe-popup {
      display: none;
      position: fixed;
      opacity: 0;
      transform: translate(-50%, 100px);
      left: 50%;
      top: 50%;
      background: rgba(255, 255, 255, 0.98);
      border-radius: 20px;
      padding: 30px 40px;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(0, 0, 0, 0.1);
      text-align: center;
      z-index: 1001;
      transition: opacity 0.8s ease, transform 0.8s ease;
    }

    .subscribe-popup.show {
      opacity: 1;
      transform: translate(-50%, -50%);
    }

    .subscribe-popup h2 {
      color: #333;
      margin-bottom: 15px;
      font-size: 1.8rem;
    }

    .subscribe-popup p {
      color: #666;
      margin-bottom: 20px;
    }

    .questions-list {
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 20px;
    }

    .question-item {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 10px;
    }

    .question-item h4 {
      color: #333;
      margin-bottom: 10px;
    }

    .question-item .options {
      font-size: 0.9rem;
      color: #666;
    }

    .question-item .correct {
      color: #28a745;
      font-weight: bold;
    }

    .error {
      color: #dc3545;
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      border-radius: 5px;
      padding: 10px;
      margin: 10px 0;
    }

    .hidden {
      display: none !important;
    }

    .settings-section {
      margin-top: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 10px;
      border: 1px solid #dee2e6;
    }

    .settings-section h3 {
      margin-bottom: 15px;
      color: #333;
    }

    /* Volume Slider */
    #musicVolumeSlider {
      width: 100%;
      margin-top: 5px;
    }

    /* Mode-specific adjustments */

    /* Vertical Mode (9:16 aspect ratio - e.g., 1080x1920) */
    .quiz-screen.vertical-mode .quiz-container {
      padding: 20px 15px; /* More vertical space */
    }
    .quiz-screen.vertical-mode .quiz-header {
      font-size: 2.2rem; /* Larger header text */
      top: 50px;
    }
    .quiz-screen.vertical-mode .timer-circle {
      width: 100px; height: 100px;
      top: 40px; right: 20px;
    }
    .quiz-screen.vertical-mode .timer-circle::before {
      width: 80px; height: 80px;
    }
    .quiz-screen.vertical-mode .timer-number {
      font-size: 3rem;
    }
    .quiz-screen.vertical-mode .question-card {
      width: 95%; /* Take more width */
      max-height: 70%; /* Allow card to use significant height */
      padding: 30px 25px;
      margin-top: 140px; /* Space below header/timer */
    }
    .quiz-screen.vertical-mode .question-text {
      font-size: 2.8rem; /* Much larger question text */
      margin-bottom: 30px;
      line-height: 1.3;
    }
    .quiz-screen.vertical-mode .options-grid {
      display: flex;
      flex-direction: column; /* Single column for options */
      gap: 15px; /* Spacing between options */
      margin-top: auto; /* Push options down if question is short */
    }
    .quiz-screen.vertical-mode .option {
      font-size: 1.8rem; /* Larger option text */
      padding: 25px 20px; /* More padding for touch */
      min-height: 80px; /* Minimum height for options */
    }
    .quiz-screen.vertical-mode .option-label {
      width: 50px; height: 50px;
      font-size: 1.5rem;
      margin-right: 20px;
    }


    /* Horizontal Mode (16:9 aspect ratio - e.g., 1920x1080) */
    .quiz-screen.horizontal-mode .quiz-container {
      padding: 15px 30px;
    }
    .quiz-screen.horizontal-mode .quiz-header {
      font-size: 2.5rem;
      top: 30px;
    }
    .quiz-screen.horizontal-mode .timer-circle {
      width: 110px; height: 110px;
      top: 20px; right: 30px;
    }
    .quiz-screen.horizontal-mode .timer-circle::before {
      width: 90px; height: 90px;
    }
    .quiz-screen.horizontal-mode .timer-number {
      font-size: 3.2rem;
    }
    .quiz-screen.horizontal-mode .question-card {
      width: 85%;
      max-height: 75%; /* Allow card to use significant height */
      padding: 35px;
      margin-top: 100px; /* Space below header/timer */
    }
    .quiz-screen.horizontal-mode .question-text {
      font-size: 2.4rem; /* Larger question text */
      margin-bottom: 25px;
      line-height: 1.4;
    }
    .quiz-screen.horizontal-mode .options-grid {
      display: flex;
      flex-direction: column; /* Single column for options */
      gap: 12px; /* Spacing between options */
      margin-top: auto; /* Push options down */
    }
    .quiz-screen.horizontal-mode .option {
      font-size: 1.6rem; /* Larger option text */
      padding: 20px;
      min-height: 70px;
    }
    .quiz-screen.horizontal-mode .option-label {
      width: 45px; height: 45px;
      font-size: 1.4rem;
      margin-right: 18px;
    }


    @media (max-width: 768px) { /* Responsive adjustments for smaller screens (non-fixed mode) */
      .options-grid {
        grid-template-columns: 1fr; /* Default to single column on smaller screens */
      }
      .options-container {
        grid-template-columns: 1fr;
      }
      .question-text { /* General smaller screen question text */
        font-size: 1.4rem;
      }
      .timer-circle {
        width: 70px; height: 70px;
        top: 15px; right: 15px;
      }
      .timer-circle::before {
        width: 50px; height: 50px;
      }
      .timer-number {
        font-size: 1.8rem;
      }
      .quiz-header {
        font-size: 1.2rem;
        top: 20px;
      }
      .home-screen {
        padding: 20px;
      }
      .logo h1 {
        font-size: 2rem;
      }
      .logo p {
        font-size: 1rem;
      }
      .btn {
        padding: 12px 24px;
        font-size: 14px;
      }
      .generate-btn {
        padding: 15px;
        font-size: 16px;
      }

      .question-card { /* General smaller screen card padding */
        padding: 20px;
        max-width: 95%;
      }
      .option-label { /* Smaller option labels for general mobile */
        width: 30px; height: 30px;
        font-size: 0.9rem;
        margin-right: 10px;
      }
      .option { /* General smaller screen option */
        font-size: 1rem;
        padding: 12px;
      }
    }

    /* This media query might conflict or be less relevant with fixed size modes,
       but kept for graceful degradation if fixed modes are not used. */
    @media (max-height: 600px) and (min-width: 769px) { /* For landscape tablets or small desktop windows */
      .question-text {
        font-size: 1.2rem;
        margin-bottom: 15px;
      }
      .options-grid {
        gap: 10px;
        margin-top: 15px;
      }
       .quiz-screen:not(.horizontal-mode):not(.vertical-mode) .option { /* Apply only if not in fixed mode */
        padding: 10px;
        font-size: 0.9rem;
      }
       .quiz-screen:not(.horizontal-mode):not(.vertical-mode) .option-label {
        width: 25px;
        height: 25px;
        /* line-height removed as flex handles centering */
        margin-right: 8px;
      }
       .quiz-screen:not(.horizontal-mode):not(.vertical-mode) .question-card {
        padding: 15px;
      }
    }
  </style>
</head>
<body>
  <!-- Home Screen -->
  <div class="container" id="homeScreen">
    <div class="home-screen">
      <div class="logo">
        <h1>🎯 Quiz Creator</h1>
        <p>Create engaging YouTube quiz videos in seconds</p>
      </div>

      <div class="tabs">
        <div class="tab active" onclick="switchTab('json')">
          JSON Input
        </div>
        <div class="tab" onclick="switchTab('manual')">
          Manual Input
        </div>
      </div>

      <div class="tab-content active" id="jsonTab">
        <textarea
          class="json-input"
          id="jsonInput"
          placeholder='Paste your JSON here or upload a file...'
        ></textarea>
        <input
          type="file"
          id="jsonFile"
          accept=".json"
          style="display: none"
          onchange="handleFileUpload(event)"
        />
        <button
          class="btn btn-secondary"
          onclick="document.getElementById('jsonFile').click()"
        >
          📁 Upload JSON File
        </button>
        <button class="btn btn-secondary" onclick="loadPreviousJSON()">
          Past JSON
        </button>
        <button class="btn btn-secondary" onclick="copyPrompt(event)">
          Copy Prompt
        </button>
      </div>

      <div class="tab-content" id="manualTab">
        <div class="question-form">
          <div class="form-group">
            <label for="questionTextManual">Question:</label>
            <input
              type="text"
              id="questionTextManual"
              placeholder="Enter your question here..."
            />
          </div>
          <div class="options-container">
            <input type="text" id="option1" placeholder="Option 1" />
            <input type="text" id="option2" placeholder="Option 2" />
            <input type="text" id="option3" placeholder="Option 3" />
            <input type="text" id="option4" placeholder="Option 4" />
          </div>
          <div class="form-group">
            <label for="correctAnswer">Correct Answer:</label>
            <select id="correctAnswer" class="correct-answer-select">
              <option value="">Select correct answer</option>
              <option value="0">Option 1</option>
              <option value="1">Option 2</option>
              <option value="2">Option 3</option>
              <option value="3">Option 4</option>
            </select>
          </div>
          <button class="btn" onclick="addQuestion()">
            ➕ Add Question
          </button>
        </div>
        <div class="questions-list" id="questionsList"></div>
      </div>

      <!-- SETTINGS SECTION -->
      <div class="settings-section">
        <h3>Quiz Settings</h3>
        <div class="form-group">
          <label for="countdownDurationSelect">Countdown Duration (seconds):</label>
          <select id="countdownDurationSelect"></select>
        </div>
        <div class="form-group">
          <label for="answerRevealDurationSelect">Answer Reveal Duration (seconds):</label>
          <select id="answerRevealDurationSelect"></select>
        </div>
        <div class="form-group">
          <label>
            <input type="checkbox" id="customQuestionRangeToggle" /> Custom Question Range (JSON tab only)
          </label>
          <div id="customRangeInputs" class="hidden" style="display: flex; gap: 10px; margin-top: 5px;">
            <input type="number" id="startQuestionIndex" placeholder="Start Q#" min="1" style="width: 48%;" />
            <input type="number" id="endQuestionIndex" placeholder="End Q#" min="1" style="width: 48%;" />
          </div>
        </div>
        <div class="form-group">
          <label for="fixedSizeSelect">Quiz Screen Size:</label>
          <select id="fixedSizeSelect">
            <option value="none">None (Fullscreen/Responsive)</option>
            <option value="vertical" selected>Vertical (1080x1920)</option>
            <option value="horizontal">Horizontal (1920x1080)</option>
          </select>
        </div>
        <div class="form-group">
          <label>
            <input type="checkbox" id="textToSpeechToggle" /> Text to Speech Mode
          </label>
        </div>
        <div class="form-group">
          <label for="backgroundMusicSelect">Background Music:</label>
          <select id="backgroundMusicSelect"></select>
        </div>
        <!-- Volume slider appears only if music is selected -->
        <div id="musicVolumeContainer" class="form-group hidden">
          <label for="musicVolumeSlider">Music Volume:</label>
          <input
            type="range"
            id="musicVolumeSlider"
            min="0"
            max="100"
            step="10"
            value="100"
          />
        </div>
      </div>
      <!-- END SETTINGS SECTION -->

      <div id="errorMessage" class="error hidden"></div>

      <button class="btn generate-btn" onclick="generateQuiz()">
        🎬 Generate Quiz Video
      </button>
    </div>
  </div>

  <!-- Quiz Screen -->
  <div class="quiz-screen" id="quizScreen">
    <div class="quiz-container">
      <div class="quiz-header" id="quizHeaderElement">
        <span id="questionCounter">Question 1 of 5</span>
      </div>
      <div class="timer-circle" id="timerCircle">
        <div class="timer-number" id="timerNumber">3</div>
      </div>

      <div class="question-card" id="questionCard">
        <div class="question-text" id="questionTextQuiz"></div>
        <div class="options-grid" id="optionsGrid"></div>
      </div>
    </div>

    <div class="subscribe-popup" id="subscribePopup">
      <p>Subscribe for more educational content like this!</p>
      <button class="btn-sbs" onclick="finishQuiz()">
        Subscribe 👆
      </button>
    </div>
  </div>

  <script>
    let currentTab = 'json';
    let questions = [];
    let originalQuestions = [];
    let currentQuestionIndex = 0;

    let audioChoose;
    let audioSubscribeNow;
    let audioTick;
    let audioCorrect;
    let audioBG = null;

    const optionPrefixes = ['A', 'B', 'C', 'D'];

    let countdownDuration = 3;
    let answerRevealDuration = 2000;
    let useCustomQuestionRange = false;
    let fixedSizeType = 'vertical';
    let useTextToSpeech = false;
    let selectedMusicPath = '';

    const backgroundMusicTracks = [
      { name: "Calm Loop", path: "./sounds/background_loop.mp3" },
      { name: "Energetic Beat", path: "./sounds/bg_energetic.mp3" },
      { name: "Study Focus", path: "./sounds/bg_study.mp3" }
    ];

    let countdownInterval;

    function switchTab(tabName) {
      currentTab = tabName;
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      const activeTabButton =
        tabName === 'json'
          ? document.querySelector('.tab:nth-child(1)')
          : document.querySelector('.tab:nth-child(2)');
      if (activeTabButton) activeTabButton.classList.add('active');
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      const activeTabContent = document.getElementById(tabName + 'Tab');
      if (activeTabContent) activeTabContent.classList.add('active');

      const customRangeToggle = document.getElementById('customQuestionRangeToggle');
      const customRangeInputs = document.getElementById('customRangeInputs');
      if (tabName !== 'json') {
        customRangeToggle.checked = false;
        customRangeToggle.disabled = true;
        useCustomQuestionRange = false;
        customRangeInputs.classList.add('hidden');
      } else {
        customRangeToggle.disabled = false;
      }
    }

    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (file && file.type === 'application/json') {
        const reader = new FileReader();
        reader.onload = e => (document.getElementById('jsonInput').value = e.target.result);
        reader.readAsText(file);
      } else {
        showError('Please select a valid JSON file.');
      }
    }

    function addQuestion() {
      const questionTextInput = document.getElementById('questionTextManual').value.trim();
      const opts = [
        document.getElementById('option1').value.trim(),
        document.getElementById('option2').value.trim(),
        document.getElementById('option3').value.trim(),
        document.getElementById('option4').value.trim()
      ];
      const correctIndex = document.getElementById('correctAnswer').value;

      if (!questionTextInput || opts.some(opt => !opt) || correctIndex === '') {
        showError('Please fill in all fields for the question.');
        return;
      }
      questions.push({
        question: questionTextInput,
        options: opts,
        correct_answer: opts[parseInt(correctIndex)]
      });
      updateQuestionsList();
      clearManualForm();
      hideError();
    }

    function updateQuestionsList() {
      const listContainer = document.getElementById('questionsList');
      listContainer.innerHTML = '';
      questions.forEach((q, index) => {
        const item = document.createElement('div');
        item.className = 'question-item';
        item.innerHTML = `
          <h4>Q${index + 1}: ${q.question}</h4>
          <div class="options">Opts: ${q.options.join(', ')}</div>
          <div class="correct">Ans: ${q.correct_answer}</div>
          <button class="btn btn-secondary" onclick="removeQuestion(${index})" style="margin-top:10px;padding:5px 10px;font-size:12px;">🗑️ Remove</button>
        `;
        listContainer.appendChild(item);
      });
    }

    function removeQuestion(index) {
      questions.splice(index, 1);
      updateQuestionsList();
    }

    function clearManualForm() {
      ['questionTextManual', 'option1', 'option2', 'option3', 'option4', 'correctAnswer'].forEach(
        id => (document.getElementById(id).value = '')
      );
    }

    function showError(message) {
      const el = document.getElementById('errorMessage');
      el.textContent = message;
      el.classList.remove('hidden');
    }

    function hideError() {
      document.getElementById('errorMessage').classList.add('hidden');
    }

    async function loadPreviousJSON() {
      try {
        const text = await navigator.clipboard.readText();
        if (text && text.trim().length > 0) {
          document.getElementById('jsonInput').value = text;
          hideError();
        } else {
          showError('Clipboard is empty or contains no text.');
        }
      } catch (err) {
        showError('Unable to read from clipboard: ' + err.message);
      }
    }

    function copyPrompt(event) {
      const promptText = `Please provide quiz questions in the following JSON format:
{
  "questions": [
    {
      "question": "Your question here?",
      "options": ["Option A", "Option B", "Option C", "Option D"],
      "correct_answer": "The text of the correct option"
    }
    // ... more questions
  ]
}
Ensure each question has exactly four options and the correct_answer matches one of the options exactly.`;
      navigator.clipboard
        .writeText(promptText)
        .then(() => {
          const btn = event.currentTarget;
          const original = btn.textContent;
          btn.textContent = 'Copied!';
          setTimeout(() => (btn.textContent = original), 1500);
        })
        .catch(err => showError('Unable to copy prompt: ' + err.message));
    }

    function initNonBgAudio() {
      if (!audioChoose) audioChoose = new Audio('./sounds/ChooseCorrectAnswer.wav');
      if (!audioSubscribeNow) audioSubscribeNow = new Audio('./sounds/Subscribe Now.wav');
      if (!audioTick) audioTick = new Audio('./sounds/timer_tick.mp3');
      if (!audioCorrect) audioCorrect = new Audio('./sounds/correct_answer.mp3');
    }

    function generateQuiz() {
      hideError();
      initNonBgAudio();

      let parsedQuestions;
      if (currentTab === 'json') {
        const jsonInput = document.getElementById('jsonInput').value.trim();
        if (!jsonInput) {
          showError('Please enter JSON data or upload a JSON file.');
          return;
        }
        try {
          const data = JSON.parse(jsonInput);
          if (!data.questions || !Array.isArray(data.questions) || data.questions.length === 0) {
            showError('Invalid JSON: "questions" array missing or empty.');
            return;
          }
          for (let i = 0; i < data.questions.length; i++) {
            const q = data.questions[i];
            if (
              !q.question ||
              typeof q.question !== 'string' ||
              !q.options ||
              !Array.isArray(q.options) ||
              q.options.length !== 4 ||
              !q.options.every(opt => typeof opt === 'string') ||
              !q.correct_answer ||
              typeof q.correct_answer !== 'string' ||
              !q.options.includes(q.correct_answer)
            ) {
              showError(
                `Q${i + 1} invalid. Format: {question:string, options:[string,string,string,string], correct_answer:string (must be one of options)}`
              );
              return;
            }
          }
          parsedQuestions = data.questions;
          localStorage.setItem('previousJSON', JSON.stringify(data));
        } catch (e) {
          showError('Invalid JSON syntax: ' + e.message);
          return;
        }
      } else {
        if (questions.length === 0) {
          showError('Please add at least one question manually.');
          return;
        }
        parsedQuestions = questions;
      }

      originalQuestions = [...parsedQuestions];
      questions = [...parsedQuestions];

      if (currentTab === 'json' && useCustomQuestionRange) {
        const startVal = document.getElementById('startQuestionIndex').value;
        const endVal = document.getElementById('endQuestionIndex').value;
        let startIdxNum = parseInt(startVal);
        let endIdxNum = parseInt(endVal);

        if (!startVal || !endVal || isNaN(startIdxNum) || isNaN(endIdxNum)) {
          showError('Please enter valid start and end question numbers for the custom range.');
          return;
        }
        if (startIdxNum < 1) startIdxNum = 1;
        if (endIdxNum > originalQuestions.length) endIdxNum = originalQuestions.length;

        if (startIdxNum > endIdxNum) {
          showError('Start question number cannot be greater than end question number.');
          return;
        }
        questions = originalQuestions.slice(startIdxNum - 1, endIdxNum);

        if (questions.length === 0) {
          showError('The selected custom range results in no questions. Check your numbers.');
          return;
        }
      }
      if (questions.length === 0) {
        showError('No questions to display. Please check your input or custom range.');
        return;
      }
      startQuiz();
    }

    function startQuiz() {
      currentQuestionIndex = 0;

      const fullscreenPromise = document.documentElement.requestFullscreen();

      fullscreenPromise
        .then(() => {
          setupQuizInterfaceAndBegin();
        })
        .catch((err) => {
          console.warn("Fullscreen request failed or was denied:", err);
          setupQuizInterfaceAndBegin(); // Proceed even if fullscreen is denied
        });
    }

    function setupQuizInterfaceAndBegin() {
      const quizScreenEl = document.getElementById('quizScreen');

      quizScreenEl.classList.remove('vertical-mode', 'horizontal-mode'); // Clear existing modes

      let scale = 1;
      if (fixedSizeType === 'vertical') {
        quizScreenEl.classList.add('vertical-mode');
        const targetWidth = 1080;
        const targetHeight = 1920;
        quizScreenEl.style.width = targetWidth + 'px';
        quizScreenEl.style.height = targetHeight + 'px';
        quizScreenEl.style.top = '50%';
        quizScreenEl.style.left = '50%';
        const scaleX = window.innerWidth / targetWidth;
        const scaleY = window.innerHeight / targetHeight;
        scale = Math.min(scaleX, scaleY); // Ensure it fits, don't scale up beyond 1 implicitly
        quizScreenEl.style.transform = `translate(-50%, -50%) scale(${scale})`;
      } else if (fixedSizeType === 'horizontal') {
        quizScreenEl.classList.add('horizontal-mode');
        const targetWidth = 1920;
        const targetHeight = 1080;
        quizScreenEl.style.width = targetWidth + 'px';
        quizScreenEl.style.height = targetHeight + 'px';
        quizScreenEl.style.top = '50%';
        quizScreenEl.style.left = '50%';
        const scaleX = window.innerWidth / targetWidth;
        const scaleY = window.innerHeight / targetHeight;
        scale = Math.min(scaleX, scaleY);
        quizScreenEl.style.transform = `translate(-50%, -50%) scale(${scale})`;
      } else { // 'none' or fullscreen/responsive
        quizScreenEl.style.width = '100vw';
        quizScreenEl.style.height = '100vh';
        quizScreenEl.style.top = '0';
        quizScreenEl.style.left = '0';
        quizScreenEl.style.transform = 'none';
      }

      document.getElementById('homeScreen').style.display = 'none';
      quizScreenEl.classList.remove('ended');
      quizScreenEl.style.display = 'block';
      document.getElementById('questionCard').style.display = 'flex'; // Changed from '' to flex
      document.getElementById('quizHeaderElement').style.display = '';
      document.getElementById('timerCircle').style.display = useTextToSpeech ? 'none' : 'flex';

      if (audioBG) {
        audioBG.currentTime = 0;
        audioBG.play().catch(e => console.warn("BG Audio play failed:", e));
      }
      showQuestion();
    }

    function speakText(text, onEndCallback) {
      if (!useTextToSpeech || !('speechSynthesis' in window)) {
        if (onEndCallback) onEndCallback();
        return;
      }
      speechSynthesis.cancel();
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.onend = function() {
        if (onEndCallback) onEndCallback();
      };
      utterance.onerror = function(event) {
        console.error('Speech synthesis error:', event.error);
        if (onEndCallback) onEndCallback(); // Ensure callback is called on error too
      };
      speechSynthesis.speak(utterance);
    }

    function showQuestion() {
      const question = questions[currentQuestionIndex];
      const questionCard = document.getElementById('questionCard');

      document.getElementById('questionCounter').textContent = `Question ${
        currentQuestionIndex + 1
      } of ${questions.length}`;
      document.getElementById('timerNumber').textContent = countdownDuration.toString();

      questionCard.className = 'question-card'; // Reset classes
      // Add back the current mode class to ensure styles apply correctly after reset
      if (fixedSizeType === 'vertical') questionCard.classList.add('vertical-mode-card-styling'); // Placeholder if specific card styles are needed
      else if (fixedSizeType === 'horizontal') questionCard.classList.add('horizontal-mode-card-styling');


      void questionCard.offsetWidth; // Trigger reflow
      questionCard.classList.add('slide-in');

      document.getElementById('questionTextQuiz').textContent = question.question;
      const optionsGrid = document.getElementById('optionsGrid');
      optionsGrid.innerHTML = '';
      question.options.forEach((optionText, index) => {
        const optionDiv = document.createElement('div');
        optionDiv.className = 'option';
        optionDiv.dataset.originalOption = optionText;
        const labelSpan = document.createElement('span');
        labelSpan.className = 'option-label';
        labelSpan.textContent = optionPrefixes[index];
        const textSpan = document.createElement('span'); // Wrap text for better control
        textSpan.textContent = optionText;
        optionDiv.appendChild(labelSpan);
        optionDiv.appendChild(textSpan);
        optionsGrid.appendChild(optionDiv);
      });

      if (useTextToSpeech) {
        document.getElementById('timerCircle').style.display = 'none';
        showQuestionWithTTS();
      } else {
        document.getElementById('timerCircle').style.display = 'flex';
        resetTimer();
        if (audioChoose) {
          setTimeout(() => {
            audioChoose.currentTime = 0;
            audioChoose.play().catch(e => console.warn("Choose audio play failed:", e));
          }, 300);
        }
        setTimeout(startCountdown, 800); // Delay before countdown starts
      }
    }

    function showQuestionWithTTS() {
      const question = questions[currentQuestionIndex];
      const questionTextToSpeak = question.question;
      const correctAnswerText = question.correct_answer;

      // 1. Speak the current question
      speakText(questionTextToSpeak, () => {
        // This callback executes after the question has finished speaking

        // 2. Wait for 1.5 seconds
        setTimeout(() => {
          // 3. Speak the correct answer
          const answerToSpeak = `${correctAnswerText}`;
          speakText(answerToSpeak, () => {
            // This callback executes after the answer has finished speaking

            // 4. Immediately highlight the correct option
            highlightCorrectOptionOnly(correctAnswerText);
            if (audioCorrect) {
              audioCorrect.currentTime = 0;
              audioCorrect.play().catch(e => console.warn("Correct audio play failed:", e));
            }

            // 5. Wait for a bit (e.g., 2 seconds) for the user to see the highlight, then transition
            setTimeout(handleNextQuestionTransition, 2000); // You can adjust this 2000ms (2s) duration
          });
        }, 1500); // 1.5-second delay
      });
    }


    function highlightCorrectOptionOnly(correctAnswerText) {
      const optionElements = document.querySelectorAll('.option');
      optionElements.forEach(optElement => {
        optElement.classList.remove('correct'); // Clear previous correct states
        if (optElement.dataset.originalOption === correctAnswerText) {
          optElement.classList.add('correct');
        }
      });
    }

    function handleNextQuestionTransition() {
      currentQuestionIndex++;
      if (currentQuestionIndex < questions.length) {
        const questionCard = document.getElementById('questionCard');
        if (questionCard.classList.contains('slide-in')) {
          questionCard.classList.replace('slide-in', 'slide-out');
        } else {
          questionCard.classList.add('slide-out');
        }
        setTimeout(showQuestion, 500); // Duration of slide-out animation
      } else {
        endQuiz();
      }
    }

    function resetTimer() {
      const timerCircle = document.getElementById('timerCircle');
      const timerNumber = document.getElementById('timerNumber');
      timerNumber.textContent = countdownDuration.toString();
      // Reset conic gradient to full
      timerCircle.style.background = `conic-gradient(#4ecdc4 0deg, #4ecdc4 360deg)`;
      // Force a reflow to ensure the transition starts correctly on the next update if needed
      void timerCircle.offsetWidth;
      // Then set the initial state for animation
      updateTimerCircle(timerCircle, countdownDuration, countdownDuration);
    }


    function startCountdown() {
      clearInterval(countdownInterval);
      let timeLeft = countdownDuration;
      const timerNumber = document.getElementById('timerNumber');
      const timerCircle = document.getElementById('timerCircle');

      timerNumber.textContent = timeLeft.toString();
      updateTimerCircle(timerCircle, timeLeft, countdownDuration); // Initial state

      countdownInterval = setInterval(() => {
        timeLeft--;
        timerNumber.textContent = timeLeft.toString();
        updateTimerCircle(timerCircle, timeLeft, countdownDuration);
        if (audioTick) {
          audioTick.currentTime = 0;
          audioTick.play().catch(e => console.warn("Tick audio play failed:", e));
        }
        if (timeLeft <= 0) {
          clearInterval(countdownInterval);
          revealAnswer();
        }
      }, 1000);
    }

    function updateTimerCircle(circleEl, timeLeft, totalDuration) {
      const elapsedRatio = (totalDuration - timeLeft) / totalDuration;
      const elapsedAngle = elapsedRatio * 360;
      // Start with the 'empty' color, then fill with the 'active' color
      circleEl.style.background = `conic-gradient(#ddd ${elapsedAngle}deg, #4ecdc4 ${elapsedAngle}deg 360deg)`;
    }


    function revealAnswer() {
      if (audioCorrect) {
        audioCorrect.currentTime = 0;
        audioCorrect.play().catch(e => console.warn("Correct audio play failed:", e));
      }
      const question = questions[currentQuestionIndex];
      highlightCorrectOptionOnly(question.correct_answer);
      setTimeout(handleNextQuestionTransition, answerRevealDuration);
    }

    function endQuiz() {
      if (audioBG) audioBG.pause();
      if (speechSynthesis && useTextToSpeech) speechSynthesis.cancel();

      document.getElementById('questionCard').style.display = 'none';
      document.getElementById('quizHeaderElement').style.display = 'none';
      document.getElementById('timerCircle').style.display = 'none';
      document.getElementById('quizScreen').classList.add('ended');

      const subscribePopup = document.getElementById('subscribePopup');
      subscribePopup.style.display = 'block';
      setTimeout(() => {
        subscribePopup.classList.add('show');
        if (audioSubscribeNow) {
          audioSubscribeNow.currentTime = 0;
          audioSubscribeNow.play().catch(e => console.warn("Subscribe audio play failed:", e));
        }
      }, 100); // Short delay before showing popup
      setTimeout(finishQuiz, 2000); // Show subscribe popup for 5 seconds
    }

    function finishQuiz() {
      if (document.fullscreenElement) {
        document.exitFullscreen().catch(err => console.warn("Error exiting fullscreen:", err));
      }

      const quizScreenEl = document.getElementById('quizScreen');
      quizScreenEl.style.display = 'none';
      quizScreenEl.classList.remove('ended', 'vertical-mode', 'horizontal-mode'); // Clear mode classes

      // Reset scaling and positioning
      quizScreenEl.style.width = '100vw';
      quizScreenEl.style.height = '100vh';
      quizScreenEl.style.top = '0';
      quizScreenEl.style.left = '0';
      quizScreenEl.style.transform = 'none';

      document.getElementById('homeScreen').style.display = 'flex'; // Use flex for container centering
      document.getElementById('questionCard').style.display = 'flex'; // Reset to flex for next quiz
      document.getElementById('quizHeaderElement').style.display = ''; // Reset

      const subscribePopup = document.getElementById('subscribePopup');
      subscribePopup.classList.remove('show');
      setTimeout(() => (subscribePopup.style.display = 'none'), 800); // Allow fade out

      questions = [];
      originalQuestions = []; // Clear questions
      updateQuestionsList(); // Update UI if manual tab was used

      window.scrollTo(0, 0); // Scroll to top of home screen
    }

    document.addEventListener('DOMContentLoaded', () => {
      switchTab('json');

      const sampleJSON = {
        questions: [
          { question: "What is the capital of France?", options: ["Berlin", "Madrid", "Paris", "Rome"], correct_answer: "Paris" },
          { question: "Which is the largest planet in our solar system?", options: ["Earth", "Mars", "Jupiter", "Saturn"], correct_answer: "Jupiter" }
        ]
      };
      document.getElementById('jsonInput').placeholder =
        'Paste JSON or Upload...\n\nExample:\n' + JSON.stringify(sampleJSON, null, 2);

      const countdownSelect = document.getElementById('countdownDurationSelect');
      const answerRevealSelect = document.getElementById('answerRevealDurationSelect');
      for (let i = 1; i <= 10; i++) {
        let option = document.createElement('option');
        option.value = i;
        option.textContent = i + (i === 1 ? ' second' : ' seconds');
        countdownSelect.appendChild(option.cloneNode(true));
        answerRevealSelect.appendChild(option.cloneNode(true));
      }
      countdownSelect.value = countdownDuration; // Default 3 seconds
      answerRevealSelect.value = answerRevealDuration / 1000; // Default 2 seconds

      countdownSelect.addEventListener('change', e => (countdownDuration = parseInt(e.target.value)));
      answerRevealSelect.addEventListener('change', e => (answerRevealDuration = parseInt(e.target.value) * 1000));

      const customRangeToggle = document.getElementById('customQuestionRangeToggle');
      const customRangeInputs = document.getElementById('customRangeInputs');
      customRangeToggle.addEventListener('change', e => {
        useCustomQuestionRange = e.target.checked;
        customRangeInputs.classList.toggle('hidden', !useCustomQuestionRange);
      });

      document.getElementById('textToSpeechToggle').addEventListener('change', e => (useTextToSpeech = e.target.checked));

      const fixedSizeSelect = document.getElementById('fixedSizeSelect');
      fixedSizeSelect.value = fixedSizeType; // Default 'vertical'
      fixedSizeSelect.addEventListener('change', e => (fixedSizeType = e.target.value));

      const musicSelect = document.getElementById('backgroundMusicSelect');
      const noMusicOption = document.createElement('option');
      noMusicOption.value = '';
      noMusicOption.textContent = 'No Music';
      musicSelect.appendChild(noMusicOption);

      backgroundMusicTracks.forEach(track => {
        const option = document.createElement('option');
        option.value = track.path;
        option.textContent = track.name;
        musicSelect.appendChild(option);
      });

      if (backgroundMusicTracks.length > 0) { // Default to first track or no music
         // musicSelect.value = backgroundMusicTracks[0].path; // Optionally default to first track
         // selectedMusicPath = backgroundMusicTracks[0].path;
         musicSelect.value = ''; // Default to No Music
         selectedMusicPath = '';
      } else {
        musicSelect.value = '';
      }
      // Initial state of volume slider based on default music selection
      const initialMusicPath = musicSelect.value;
      const volumeContainer = document.getElementById('musicVolumeContainer');
      if (initialMusicPath) {
          if (!audioBG) audioBG = new Audio(initialMusicPath);
          audioBG.loop = true;
          audioBG.volume = document.getElementById('musicVolumeSlider').value / 100;
          volumeContainer.classList.remove('hidden');
      } else {
          volumeContainer.classList.add('hidden');
      }


      musicSelect.addEventListener('change', e => {
        selectedMusicPath = e.target.value;
        const volumeSlider = document.getElementById('musicVolumeSlider');
        if (audioBG) { // Pause and clear existing audio
          audioBG.pause();
          audioBG.src = ''; // Release resource
        }
        if (selectedMusicPath) {
          audioBG = new Audio(selectedMusicPath);
          audioBG.loop = true;
          audioBG.volume = volumeSlider.value / 100;
          volumeContainer.classList.remove('hidden');
        } else {
          audioBG = null; // No music selected
          volumeContainer.classList.add('hidden');
        }
      });

      const volumeSlider = document.getElementById('musicVolumeSlider');
      volumeSlider.addEventListener('input', e => {
        const val = parseInt(e.target.value);
        if (audioBG) {
          audioBG.volume = val / 100;
        }
      });
    });
  </script>
</body>
</html>
